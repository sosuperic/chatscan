<!DOCTYPE html>
<html lang="en">
<head>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.13/d3.js" charset="utf-8"></script>
     <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script> -->
    <script src="js/d3.js" charset="utf-8"></script>
    <script src="js/jquery-1.10.2.js"></script>
</head>
    
<body>
    <div id='tensionSlider'>
      Tension&nbsp;&nbsp;<input type="range" id="tensionSlider" min="0.0" max="1.0" step="0.01" value="0.75" style="width: 100px;">
    </div>
	<div id="viz"></div>
    <script>
        const DISPLAY_NAME = true;
        const DISPLAY_AXES = false;

        var svg = d3.select("#viz")
        .append("svg")
        .attr("width", 1000)
        .attr("height", 1000);

        // var bsplineLine = d3.svg.line()
        //     .x(function(d) { return d[0]; })
        //     .y(function(d) { return d[1]; })
        //     .interpolate("basis-closed");
        
        var tension = 0.75;
        var cardinal_line;
        function define_cardinal_line() {
            cardinal_line = d3.svg.line()
            .x(function(d) { return d[0]; })
            .y(function(d) { return d[1]; })
            .interpolate("cardinal-closed")
            .tension(tension);
        }
        define_cardinal_line();

        // Redraw blobs when slider moves
        $('input').on('change', function() {
            tension = $('input').val();
            $('.blob').remove();
            define_cardinal_line();
            draw_img_blob();
            draw_color_blob();
            console.log(tension);
        });

        // DATA. TODO: read in JSON file
        // var n = 5;
        // var signals = ['NEWS CENTRALITY', 'TWITTER CENTRALITY', 'AVERAGE RETWEETS', 'FOLLOWER COUNT', 'MENTIONS COUNT'];
        // // Influence metrics, normalized to [0,1] (subtract min, divide by range)
        // var metric_details = ['Rank: 3', 'Rank: 78', '310.8', '732K', '2.4K'];
        // var metrics = [0.95, 0.46, 0.7, 0.66, 0.87];
        var n = 6;
        var signals = ['NEWS CENTRALITY', 'TWITTER CENTRALITY', 'AVERAGE RETWEETS', 'FOLLOWER COUNT', 'MENTIONS COUNT', 'PLACEHOLDER'];
        // Influence metrics, normalized to [0,1] (subtract min, divide by range)
        var metric_details = ['Rank: 3', 'Rank: 78', '310.8', '732K', '2.4K', 'whoknows']
        var metrics = [0.95, 0.41, 0.72, 0.69, 0.81, 0.67];
        var final_score = 88;
        var name = 'TED CRUZ';

        // X, Y LOCATIONS points
        var center = [300,300];
        var radius = 200;
        var label_radius = radius * 1.3;
        var vertices = [];
        var label_vertices = [];
        for (var i = 0; i < n; i += 1) {
            var pt = [center[0] + radius * Math.cos(-Math.PI/2 + (i * 2 * Math.PI / n)),
                center[1] + radius * Math.sin(-Math.PI/2 + (i * 2 * Math.PI / n))];
            vertices.push(pt);
            var pt = [center[0] + label_radius * Math.cos(-Math.PI/2 + (i * 2 * Math.PI / n)),
                center[1] + label_radius * Math.sin(-Math.PI/2 + (i * 2 * Math.PI / n))];
            label_vertices.push(pt);
        }


        // DRAW BACKGROUND CIRCLES
        var small_c_radius = 0.5 * radius;
        /* Method 1 - picture inside smallest circle. 
        // Can comment out smallest svg.append('circle') 
        // Clip path for smallest circle
        svg.insert('svg:defs', ":first-child")
            .insert('clipPath')
            .attr("id", "pic")
            .insert("circle")
            .attr("stroke", "#000000")
            .attr("cx", small_c_radius)
            .attr("cy", small_c_radius)
            .attr("r", small_c_radius);
        var small_c = svg.append('g')
            .attr('class', 'backgroundC')
            .attr('transform', function() {
                var start_x = center[0] - small_c_radius;
                var start_y = center[1] - small_c_radius;
                return 'translate(' + start_x + ',' + start_y + ')';});
        small_c.append('image')
          .attr('xlink:href', 'imgs/' + name + '.jpg')
            .attr('height', small_c_radius * 2)
            .attr('width', small_c_radius * 2)
          .attr('opacity', 0.3)
          .attr('clip-path', 'url(#pic)');
        */

        // Draw circles
        var small_c = svg.append('g')
            .attr('class', 'backgroundC')
            .attr('transform', function() {
                var start_x = center[0] - small_c_radius;
                var start_y = center[1] - small_c_radius;
                return 'translate(' + start_x + ',' + start_y + ')';});
        small_c.append('circle')
          .attr('cx', small_c_radius)
          .attr('cy', small_c_radius)
          .attr('r', small_c_radius)
          .attr("stroke", "#193366")
          .attr("stroke-width", 1)
          .attr('fill', 'cccccc')
          .attr('opacity', 0.05);
        svg.append('circle')
          .attr('cx', center[0])
          .attr('cy', center[1])
          .attr('r', 0.75 * radius)
          .attr("stroke", "#193366")
          .attr("stroke-width", 1)
          .attr('fill', 'cccccc')
          .attr('opacity', 0.04);
        svg.append('circle')
          .attr('cx', center[0])
          .attr('cy', center[1])
          .attr('r', radius)
          .attr("stroke", "#193366")
          .attr("stroke-width", 1)
          .attr('fill', 'cccccc')
          .attr('opacity', 0.03);

        // DRAW AXES
        if (DISPLAY_AXES) {
            var ga = svg.append("g")
                .attr("transform", "translate(" + center[0] + "," + center[1] + ")")
                .append('g')
                .attr("class", "a axis")
              .selectAll("g")
                .data(d3.range(90 - 360/n, 360, 360/n))
              .enter().append("g")
                .attr("transform", function(d) { return "rotate(" + -d + ")"; });
                
            ga.append("line")
                .attr('x1', 30)
                .attr("x2", radius)
              .attr("stroke", "#193366")
              .attr("stroke-width", 1)
              .attr('opacity', 0.1);
        }

        // APPEND LABELS FOR EACH AXIS
        labels = svg.append('g')
          .attr('class', 'axisLabels')
          .selectAll('text')
          .data(signals)
          .enter()
          .append('g')
          .attr('class', 'axisLabel')
          .append('text')
          .attr('x', function(d, i) {return label_vertices[i][0]; })
          .attr('y', function(d, i) {return label_vertices[i][1]; })
          .text(function(d,i) {return d; })
          .attr('font-family', 'Helvetica, sans-serif')
          .attr('font-size', '12px')
          .attr('opacity', 0.6)
          .attr('font-weight', 900)
          .attr('letter-spacing', '2px')
          .attr('text-anchor', 'middle');
          
        function insert_line_breaks(d, i) {
            var el = d3.select(this);
            var words = d.split(' ');
            el.text('');

            for (var j = 0; j < words.length; j++) {
                var tspan = el.append('tspan').text(words[j]);
                if (j > 0)
                    tspan.attr('x', label_vertices[i][0])
                        .attr('dy', '15');
            }
        };
        svg.selectAll('.axisLabel text').each(insert_line_breaks);

         // Append metrics details for each axis
         if (typeof metric_details !== 'undefined') {
            label_details = svg.append('g')
              .attr('class', 'axisLabelDetails')
              .selectAll('text')
              .data(metric_details)
              .enter()
              .append('g')
              .attr('class', 'axisLabelDetail')
              .append('text')
              .attr('x', function(d, i) {return label_vertices[i][0]; })
              .attr('y', function(d, i) {return label_vertices[i][1] + 32; }) // TODO: matters when label is 2 words vs 1
              .text(function(d,i) {return d; })
              .attr('font-family', 'Helvetica, sans-serif')
              .attr('font-size', '12px')
              .attr('opacity', 0.6)
              .attr('text-anchor', 'middle');
        }
         
        

        // DRAW BLOBS
        // Get blob control points from vertices of regular polygon
        function get_coordinates(center, metrics) {
          coords = [];
          for(var i=0; i<metrics.length; i++) {
            x = center[0] + metrics[i] * (vertices[i][0] - center[0]);
            y = center[1] + metrics[i] * (vertices[i][1] - center[1]);
            coords.push([x,y]);
          }
          return coords;
        };
        var profile_coords = get_coordinates(center, metrics);
        var clip_coords = get_coordinates(center, metrics);

        // DRAW IMG BLOB
        var img_blob = svg.append('g');
        var img_pad_ratio = Math.min(1.0, 1.1*Math.max(...metrics));
        function draw_img_blob() {
            svg.insert('svg:defs', ":first-child")
                .attr('class', 'blob') // TODO: clean up g/class wonkiness
                .insert('clipPath')
                .attr("id", "pic2")
                .append('path')
              .attr("d", cardinal_line(clip_coords))
              .attr("stroke", "#0065cc")
              .attr("stroke-width", 2);

            svg.insert('svg:defs', ":first-child")
                .attr('class', 'blob') // TODO: clean up g/class wonkiness
                .insert('filter')
                .attr("id", "saturate")
                .append('feColorMatrix')
              .attr("in", "SourceGraphic")
              .attr("type", "saturate")
              .attr("values", ".0");

            img_blob.append('image')
                .attr('class', 'blob') // TODO: clean up g/class wonkiness
              .attr('xlink:href', 'imgs/' + name + '.jpg')
                .attr('x', center[0] - img_pad_ratio*radius)
                .attr('y', center[1] - img_pad_ratio*radius)
                .attr('height', 2*img_pad_ratio*radius)
                .attr('width',  2*img_pad_ratio*radius)
              .attr('opacity', 0.4)
              .attr('filter', 'url(#saturate)')
              .attr('clip-path', 'url(#pic2)');
        }
        draw_img_blob();
        
        // DRAW COLOR BLOB.
        function draw_color_blob() {
            svg.append('path')
            .attr('class', 'blob')
          // .attr("d", cardinal_line([profile_coords[0], profile_coords[1],
          // profile_coords[2], profile_coords[3], profile_coords[4]]))
            .attr('d', cardinal_line(profile_coords))
          .attr("stroke", "#0065cc")
          .attr("stroke-width", 2)
          .attr('opacity', 0.5)
        //   .transition()
        //   .duration(200)
        //   .attrTween("stroke-dasharray", function() {
        //   var len = this.getTotalLength();
        //   return function(t) { return (d3.interpolateString("0," + len, len + ",0"))(t) };
        // })
          .attr('fill', '#0065cc')
        }
        draw_color_blob();
          
        
        // FINAL SCORE
        small_c.append('text')
           .attr('x', small_c_radius)
           .attr('y', small_c_radius + 20)  // TODO: center automatically...
           .text(final_score)
          .attr('font-family', 'Helvetica, sans-serif')
          .attr('font-size', '64px')
          .attr('opacity', 1.0)
          // .attr('opacity', 0.0)
          .attr('font-weight', 900)
          .style('fill', 'black')
          .attr('text-anchor', 'middle');
         
        // NAME
        // TODO: where to place name if say n = 6 and there is label at the botom?
        if (DISPLAY_NAME) {
            svg.append('text')
              .attr('x', center[0])
              .attr('y', center[1] + 1.3 * label_radius)
              // .text(name + ' (' + final_score + ')')
              .text(name)
              .attr('font-family', 'Helvetica, sans-serif')
              .attr('font-size', '32px')
              .attr('opacity', 0.8)
              .attr('font-weight', 'bold')
              .attr('text-anchor', 'middle');
        }

    </script>
</body>
